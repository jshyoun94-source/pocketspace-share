rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function isSelf(userId) {
      return signedIn() && request.auth.uid == userId;
    }

    function isChatMember(data) {
      return signedIn()
        && (request.auth.uid == data.ownerId || request.auth.uid == data.customerId);
    }

    function parentChat(chatId) {
      return get(/databases/$(database)/documents/chats/$(chatId));
    }

    function parentChatExists(chatId) {
      return exists(/databases/$(database)/documents/chats/$(chatId));
    }

    // -------------------------
    // users
    // -------------------------
    match /users/{userId} {
      // 채팅에서 상대 닉네임 읽기 필요 → 로그인만 하면 read OK
      allow read: if signedIn();
      allow create, update, delete: if isSelf(userId);

      // -------------------------
      // users/{userId}/favorites (즐겨찾기)
      // -------------------------
      match /favorites/{favoriteId} {
        // 본인만 읽기/쓰기 가능
        allow read, write: if isSelf(userId);
      }
    }

    // -------------------------
    // spaces
    // -------------------------
    match /spaces/{spaceId} {
      // 로그인 여부와 관계없이 모든 사용자가 공간 정보를 읽을 수 있음
      allow read: if true;

      allow create: if signedIn()
        && request.resource.data.ownerId == request.auth.uid;

      // 소유자: 전체 수정/삭제 가능
      // 비소유자: viewCount, favoriteCount, updatedAt만 수정 가능 (조회수/즐겨찾기 증감용)
      allow update: if signedIn() && (
        resource.data.ownerId == request.auth.uid
        || (
          (
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount', 'updatedAt'])
            || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['favoriteCount', 'updatedAt'])
            || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount', 'favoriteCount', 'updatedAt'])
          )
          && request.resource.data.ownerId == resource.data.ownerId
        )
      );
      allow delete: if signedIn()
        && resource.data.ownerId == request.auth.uid;
    }

    // -------------------------
    // chats
    // -------------------------
    match /chats/{chatId} {

      // ✅ 중요:
      // getDoc(단건)는 "없어도" 허용해야 존재 여부 확인이 가능함
      // list 쿼리 결과의 각 문서도 이 get 규칙으로 검증됨
      allow get: if signedIn() && (resource == null || isChatMember(resource.data));

      // list(쿼리): 로그인한 사용자만 쿼리 가능
      // 쿼리 결과의 각 문서는 위의 get 규칙으로 자동 검증됨
      // (isChatMember 체크를 통과한 문서만 반환됨)
      allow list: if signedIn();

      // 생성: owner/customer 중 한 명이 본인일 때
      allow create: if signedIn()
        && request.resource.data.keys().hasAll(['ownerId','customerId','spaceId'])
        && (request.auth.uid == request.resource.data.ownerId ||
            request.auth.uid == request.resource.data.customerId);

      // 수정/삭제: 참여자만
      allow update, delete: if resource != null && isChatMember(resource.data);

      // -------------------------
      // messages
      // -------------------------
      match /messages/{messageId} {
        allow get, list: if parentChatExists(chatId)
          && isChatMember(parentChat(chatId).data);

        // create:
        // - 참여자
        // - senderId가 본인이거나 "system" 허용
        allow create: if parentChatExists(chatId)
          && isChatMember(parentChat(chatId).data)
          && request.resource.data.keys().hasAll(['text','senderId','createdAt'])
          && (
            request.resource.data.senderId == request.auth.uid ||
            request.resource.data.senderId == "system"
          );

        allow update, delete: if false;
      }
    }

    // -------------------------
    // communityPosts (동네생활)
    // -------------------------
    match /communityPosts/{postId} {
      // 모든 사용자가 읽을 수 있음 (반경 5km 필터링은 클라이언트에서)
      allow read: if true;
      
      // 로그인한 사용자만 작성 가능
      allow create: if signedIn()
        && request.resource.data.authorId == request.auth.uid
        && request.resource.data.keys().hasAll(['authorId', 'authorName', 'content', 'location', 'createdAt', 'expiresAt']);
      
      // 작성자만 수정/삭제 가능
      allow update, delete: if signedIn()
        && resource.data.authorId == request.auth.uid;
      
      // 댓글
      match /comments/{commentId} {
        allow read: if true;
        allow create: if signedIn()
          && request.resource.data.authorId == request.auth.uid
          && request.resource.data.keys().hasAll(['postId', 'authorId', 'authorName', 'content', 'createdAt']);
        allow update, delete: if signedIn()
          && resource.data.authorId == request.auth.uid;
      }
    }

    // -------------------------
    // transactions (보관 거래 - 마음공간)
    // -------------------------
    function isTransactionParty(data) {
      return signedIn()
        && (request.auth.uid == data.ownerId || request.auth.uid == data.customerId);
    }
    function isTransactionReadableByChatMember() {
      return resource != null
        && resource.data.chatId != null
        && exists(/databases/$(database)/documents/chats/$(resource.data.chatId))
        && isChatMember(get(/databases/$(database)/documents/chats/$(resource.data.chatId)).data);
    }
    match /transactions/{transactionId} {
      allow read: if signedIn() && resource != null
        && (isTransactionParty(resource.data) || isTransactionReadableByChatMember());
      allow create: if signedIn()
        && request.resource.data.keys().hasAll(['spaceId','ownerId','customerId','chatId','status'])
        && isTransactionParty(request.resource.data);
      allow update, delete: if resource != null && isTransactionParty(resource.data);
    }

    // -------------------------
    // neighborhoodRequests (동네부탁)
    // -------------------------
    match /neighborhoodRequests/{requestId} {
      // 모든 사용자가 읽을 수 있음
      allow read: if true;
      
      // 로그인한 사용자만 작성 가능
      allow create: if signedIn()
        && request.resource.data.authorId == request.auth.uid
        && request.resource.data.keys().hasAll(['authorId', 'authorName', 'title', 'content', 'price', 'location', 'createdAt', 'status']);
      
      // 작성자, 이미 수락한 사용자, 또는 수락 요청자(acceptedBy를 본인으로 설정)만 수정 가능
      allow update: if signedIn()
        && (resource.data.authorId == request.auth.uid
            || resource.data.acceptedBy == request.auth.uid
            || (request.auth.uid != resource.data.authorId
                && request.resource.data.acceptedBy == request.auth.uid
                && request.resource.data.status == "in_progress"));
      
      // 작성자만 삭제 가능
      allow delete: if signedIn()
        && resource.data.authorId == request.auth.uid;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
