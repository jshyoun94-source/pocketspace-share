# 안심번호통화 연동 가이드

채팅창 통화 버튼은 **약속잡기 요청·수락이 끝난 뒤(약속중/보관중)** 에만 활성화됩니다.  
실제 통화는 **안심번호(050 등)** 로 연결되며, 상대에게 본인 번호가 노출되지 않습니다.

---

## 개발 단계 추천: 간단·저렴하게 시작하기

### 1순위: 엠투넷(MTONET) — 050 안심번호 전문

| 항목 | 내용 |
|------|------|
| **적합한 이유** | 050 안심번호 API 전문, **스타트업/소규모** 요금제 있음, **당일 연동** 가능한 수준의 HTTP API |
| **요금 (참고)** | **스타트업**: 월 **5만원** (100회선 이하) / **기본형**: 월 30만원 (1,000회선 이하) |
| **연동 난이도** | REST API, 초급 개발자도 당일 연동 가능하다는 수준으로 문서·구조 단순 |
| **문의** | **070-8014-8888** / **finehour@mtonet.co.kr** / 카카오톡 **@안심번호** |
| **사이트** | [엠투넷 블로그·안내](https://mtonet.tistory.com) 등 검색 후 공식 사이트 문의 |

**진행 방법**

1. 위 연락처로 **“앱에서 채팅 상대와 안심번호 통화 연결 API”** 용도로 문의
2. **스타트업/소규모 요금제** 및 **테스트 계정·API 문서** 요청
3. 문서 받은 뒤 `POST /call/masked` 안에서 **“A번호–B번호 연결 → 발신자가 걸 번호(050xxxx) 반환”** API 호출 로직만 추가

---

### 2순위: 비용을 더 줄이고 싶을 때

- **당장 통화만 필요**하다면  
  - 안심번호 연동 전까지는 **현재처럼 501 스텁 유지** → 앱에서 “준비 중” 안내  
  - 또는 **일반 전화 연결**(`tel:상대번호`)로 임시 오픈 (번호 노출됨, 개인정보 고려 필요)
- **다른 업체 검토**  
  - 통신사 B2B 안심번호, 다른 CP(특수부가통신사업자) 050 API를 직접 문의해 비교

---

### Twilio는 어떤가요?

Twilio는 **전혀 나쁜 서비스가 아닙니다.** 다만 **지금 우리 앱·한국 시장**에는 아래 이유로 **우선 추천하기 어렵습니다.**

| 항목 | Twilio | 우리 앱에 맞는 선택 |
|------|--------|----------------------|
| **Proxy(번호 마스킹)** | **Twilio Proxy**가 “두 사람 연결 + 번호 숨김”에 딱 맞는 기능이었음 | **2024년 기준 신규 가입 불가**(EOS). 기존 고객만 사용 가능. 새로 시작하는 앱에는 쓸 수 없음 |
| **대안(Conversations + Voice)** | Proxy 대신 직접 구현 가능 | 세션·참가자·번호 풀 등을 직접 설계해야 해서 **연동 난이도·개발량이 큼** |
| **한국·050** | 글로벌 중심. **한국 현지 번호(050 등) 지원이 제한적**일 수 있음 | 국내 사용자 기대는 **“050 안심번호”** → **국내 CP(엠투넷 등)** 가 050·한국 통화에 맞음 |
| **문서·지원** | 영어 문서·글로벌 지원 좋음 | 국내 업체는 **한국어 문의·스타트업 요금**으로 시작하기 수월함 |

**정리**

- **Twilio**: 글로벌 서비스·API 품질은 좋지만,  
  - Proxy는 **신규 불가**,  
  - 한국 050·로컬 번호는 **국내 전문 업체가 유리**  
  → **한국 앱 + 안심번호(050)** 용도에는 **엠투넷(MTONET) 등을 먼저 추천**
- **Twilio를 고려할 수 있는 경우**  
  - 해외 번호·해외 사용자 대상 마스킹 통화를 나중에 추가할 때  
  - Proxy 예외(Exemption) 신청이 통과된 계정이 있을 때  

즉, Twilio가 “별로”라서가 아니라, **지금 요구사항(한국 앱 + 050 안심번호 + 신규 개발)** 에는 **국내 050 전문 업체(엠투넷 등)** 가 더 잘 맞다는 의미입니다.

---

### 개발 단계에서의 진행 순서 (엠투넷 기준)

1. **문의**  
   - 엠투넷에 “앱 간 안심번호 통화 연결” 용도 + 스타트업 요금제 문의  
   - 테스트용 API 키·문서·연동 가이드 요청  

2. **전화번호 수집**  
   - Firestore `users/{uid}` 에 **전화번호 필드**(예: `phoneNumber`) 추가  
   - 앱: 프로필/마이페이지에 “안심통화용 전화번호” 입력·저장 화면 추가  

3. **Functions 연동**  
   - `functions/src/index.ts` 의 **`POST /call/masked`** 안에서  
     - 이미 구현된 `callerPhone`, `calleePhone` 사용  
     - 엠투넷 API 문서대로 **“연결 요청”** 호출 → 응답에서 **발신자가 걸 번호**(050xxxx) 추출  
     - `return res.json({ numberToDial: "050xxxx..." });` 로 반환  

4. **앱**  
   - 이미 구현됨: 위 `numberToDial` 수신 시 `Linking.openURL('tel:' + numberToDial)` 로 발신  

5. **테스트**  
   - 약속 확정된 채팅에서 통화 버튼 → “안심번호로 통화” → 실제 연결되는지 확인  

---

## 현재 구현 상태

- **앱**: 약속 확정 후 통화 버튼 활성화 → "안심번호로 통화" 확인 → `POST /call/masked` 호출 → 받은 번호로 `tel:` 연결
- **Functions**: `POST /call/masked` 스텁 구현. 인증·채팅방·참여자 검증 후 **501 (NOT_CONFIGURED)** 반환.  
  → 안심번호 API 연동 후 여기서 `numberToDial`을 만들어 반환하면 앱에서 그대로 발신 가능

## 안심번호 서비스 연동 절차

### 1. 서비스 선택

- **엠투넷(MTONET)**  
  - 050 안심번호 API (REST), CDR·통계 제공  
  - 번호 1개당 월 2,200원(VAT 포함) 수준, 대량 시 할인  
  - [엠투넷](https://mtonet.co.kr) 문의 후 API 키·문서 확보

- 그 외: 통신사 B2B 안심번호, 다른 CP 사업자 API 등 검토 가능

### 2. Firestore 사용자 전화번호

안심번호 연동 시 **발신자·수신자 번호**가 필요합니다.

- **필드**: `users/{uid}` 문서에 `phoneNumber` (또는 `phone`) 저장
- **수집**: 프로필/마이페이지에 "전화번호 (안심통화용)" 입력란 추가 후 저장
- **규칙**: `firestore.rules`에서 본인만 `phoneNumber` 읽기/쓰기 허용 권장

### 3. Functions 연동

`functions/src/index.ts` 의 `POST /call/masked` 안에서:

1. 위에서 이미 조회한 `callerPhone`, `calleePhone` 사용
2. 선택한 안심번호 API(예: MTONET) 호출
   - "A 번호 ↔ B 번호" 연결 요청
   - 응답으로 **발신자가 걸 번호**(050xxxx 등) 수신
3. `numberToDial` 값을 그대로 반환:

```ts
// 예시 (실제 API는 제공처 문서 참고)
const numberToDial = await yourMaskedCallApi.requestBridge(callerPhone, calleePhone);
return res.json({ numberToDial });
```

4. 환경 변수에 API 키/시크릿 저장 후, Functions에서만 참조하도록 구성

### 4. 앱 동작 (이미 구현됨)

- **통화 불가**: 약속 확정 전 → "약속이 확정된 후에 통화할 수 있습니다" 안내
- **통화 가능**: 약속중/보관중 → "안심번호로 통화" 확인 후 서버 호출 → 받은 번호로 `tel:` 연결

501/연동 전에는 "안심번호 통화 서비스 연동 준비 중입니다" 메시지가 뜹니다.

## 요약

| 항목 | 내용 |
|------|------|
| 통화 버튼 활성화 시점 | 약속잡기 요청 후 **상대가 수락한 뒤**(약속중 또는 보관중) |
| 번호 노출 | 안심번호(050 등)로 연결되어 상대에게 본인 번호 비노출 |
| 연동 전 | 501 반환 → 앱에서 "준비 중" 안내 |
| 연동 시 | `users` 의 `phoneNumber` 사용 + 안심번호 API 호출 후 `numberToDial` 반환 |
