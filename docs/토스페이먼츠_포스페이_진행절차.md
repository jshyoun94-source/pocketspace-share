# 토스페이먼츠 연동 · 포스페이(충전/잔액) 진행 절차

> PG·전자결제 업체(토스페이먼츠)를 이용한 충전/잔액 방식, 법·보안 고려 사항 포함  
> 순차적으로 따라가면 됩니다.

---

## 0. 구조 이해 (한 줄 요약)

- **충전**: 사용자가 카드 등으로 결제 → 토스페이먼츠 **결제 API** → 결제 성공 시 **당신 서버(DB)**에 "포스페이 잔액" 적립.
- **잔액**: **당신 DB(Firestore 등)**에서만 관리. 토스는 "돈 들어오는 통로"만 담당.
- **결제(이용자 → 공간 등록자)**: 당신 서버에서 잔액 차감/적립 처리 후, 공간 등록자 **출금** 시 토스 정산 또는 계좌이체로 지급.

즉, **잔액은 우리가 관리하고, 실제 돈의 입·출금만 토스페이먼츠를 통해** 처리합니다.

---

## 1단계: 사전 준비 (1~2일)

### 1.1 서비스 정책 정리

- **포스페이 이용약관**  
  - 충전금은 "고객 예치금"이며 플랫폼 매출이 아님.  
  - 미사용 잔액 환불 조건, 수수료(있으면), 유효기간(있으면) 명시.
- **개인정보처리방침**  
  - 결제·잔액·정산에 필요한 항목(카드 정보는 토스가 처리하므로 "결제 대행을 위해 PG사에 전달" 정도로 명시).
- **플랫폼 수수료**  
  - 공간 이용료의 몇 %를 플랫폼이 가져갈지 결정 (이 부분만 당신 매출·과세 대상).

### 1.2 사업자·계좌

- 사업자등록증, 통장(정산받을 계좌) 준비.
- 토스페이먼츠 가맹점 계약 시 **정산 계좌**로 사용.

### 1.3 개발 환경

- 프로젝트: Expo/React Native, Firebase(Firestore, Cloud Functions) 가정.
- 토스페이먼츠는 **클라이언트 키**(앱 노출용) + **시크릿 키**(서버 전용, 절대 노출 금지) 사용.

---

## 2단계: 토스페이먼츠 개발자센터 가입 · 테스트 키 발급 (당일)

1. **개발자센터 접속**  
   - [토스페이먼츠 개발자센터](https://developers.tosspayments.com/)  
   - 회원가입(이메일 등).

2. **전자결제 신청**  
   - 개발자센터 내 "전자결제 신청" 진행.  
   - 사업자 정보, 서비스 개요(포켓스페이스 · 공간 대여 플랫폼, 포스페이 충전/결제) 입력.

3. **API 키 확인**  
   - **API 키** 메뉴에서 **테스트 키** 확인.  
   - `test_ck_...` (클라이언트 키), `test_sk_...` (시크릿 키).  
   - 테스트 키로는 실제 금액 차감 없음.

4. **문서 훑어보기**  
   - [시작하기](https://docs.tosspayments.com/guides/v2/get-started)  
   - [결제 연동](https://docs.tosspayments.com/guides/v2/payment)  
   - [결제 승인 API](https://docs.tosspayments.com/reference#결제-승인) (충전 시 "결제 생성 → 결제 승인" 흐름 사용).

---

## 3단계: 아키텍처 및 데이터 설계 (1~2일)

### 3.1 흐름 정리

| 구분 | 담당 | 설명 |
|------|------|------|
| 충전 | 토스 결제 API + 우리 백엔드 | 사용자가 "포스페이 충전" → 결제창 → 승인 → **우리 서버**에서 잔액 증가 |
| 잔액 보관 | 우리 DB | Firestore 등에 `users/{uid}/balance` 또는 `wallets/{uid}` 형태로 저장 |
| 결제(이용자→등록자) | 우리 백엔드만 | 이용자 잔액 차감, 등록자 "출금 가능 잔액" 증가 (DB 트랜잭션) |
| 출금(등록자) | 우리 백엔드 + 토스/은행 | 등록자가 출금 요청 → 우리가 등록자 계좌로 송금 (토스 정산 API 또는 계좌이체) |

### 3.2 Firestore 구조 예시

- `users/{userId}`  
  - `balance` (number): 포스페이 잔액 (이용자·등록자 겸용 가능).  
  - 또는 `wallets/{userId}` 에 `balance`, `withdrawableBalance`(등록자만) 등.
- `transactions` (또는 `payments`)  
  - `type`: 'charge' | 'payment' | 'withdraw' | 'refund'  
  - `userId`, `amount`, `orderId`, `createdAt`, `status`, `metadata`(공간ID, 상대방 등).
- `orders` (토스 결제용)  
  - `orderId`(고유), `userId`, `amount`, `status`, `paymentKey`(토스 승인 후 저장 시 암호화 등 보안 고려).

### 3.3 보안 원칙

- **잔액 증감은 전부 서버(Cloud Functions)에서만** 처리. 클라이언트는 "요청"만.
- **시크릿 키**는 서버 환경변수에만 두고, 앱에는 **클라이언트 키**만.
- 카드 번호 등 결제 정보는 토스 결제창에만 입력. 우리 서버/DB에 저장하지 않음.
- 충전·결제·출금 전부 **로그(누가, 언제, 얼마, orderId)** 남기기.

---

## 4단계: 백엔드 구현 (Cloud Functions 등) (3~5일)

1. **결제(충전) 승인 API**  
   - 클라이언트가 토스 결제창으로 결제 후 `paymentKey`, `orderId`, `amount` 받음.  
   - 이 값을 **우리 서버**로 보내면, 서버에서 토스 **승인 API** 호출 (시크릿 키 사용).  
   - 성공 시:  
     - 해당 `orderId` 중복 처리 방지 (이미 처리된 주문이면 잔액 추가 X).  
     - `users/{userId}.balance` 증가.  
     - `transactions`에 type `charge` 로 기록.

2. **잔액 조회**  
   - 인증된 사용자만 `users/{userId}.balance` 조회 가능 (Firestore 규칙 + API 검증).

3. **결제(이용자 → 공간 등록자)**  
   - 서버 함수: 이용자 userId, 등록자 ownerId, 금액, 공간/예약 정보 입력.  
   - 이용자 잔액 >= 금액인지 확인 후,  
     - 이용자 잔액 -= 금액,  
     - 등록자 출금가능잔액 += (금액 - 플랫폼 수수료),  
     - 플랫폼 수수료는 별도 집계 또는 당신 매출 계정에.  
   - `transactions`에 type `payment` 기록.

4. **출금 요청(등록자)**  
   - 등록자가 출금 요청 시: 출금가능잔액 확인 → 토스 정산 API 또는 당신 계좌에서 등록자 계좌로 이체.  
   - 출금가능잔액 차감, `transactions`에 type `withdraw` 기록.

5. **Idempotency**  
   - 결제 승인·잔액 증감 시 `orderId` 또는 고유 요청 ID로 중복 실행 방지.

---

## 5단계: 앱(클라이언트) 연동 (3~5일)

1. **토스페이먼츠 결제창**  
   - 웹뷰 또는 토스 제공 결제창 URL/JS SDK 사용.  
   - "포스페이 충전" 버튼 → **우리 서버**에서 `orderId` 생성 및 결제 요청 정보 반환 → 결제창 호출 → 결제 완료 시 `paymentKey`, `orderId`, `amount`를 우리 서버로 전달.

2. **잔액 표시**  
   - Firestore `users/{userId}.balance` 구독 또는 API로 조회 후 화면에 표시.

3. **결제 플로우**  
   - 공간 이용 확정 시 "포스페이로 결제" 버튼 → 우리 서버 API 호출 (결제 처리) → 성공 시 화면 갱신.

4. **키 관리**  
   - 앱에는 **클라이언트 키**만 넣기 (환경변수 `EXPO_PUBLIC_` 등). 시크릿 키는 절대 앱에 두지 않기.

---

## 6단계: 토스페이먼츠 정식 가맹점 계약 · 라이브 전환 (1~2주)

1. **정식 가맹점 계약**  
   - 토스페이먼츠에 정식 전자결제(가맹점) 계약 요청.  
   - 제출 서류: 사업자등록증, 정산 계좌, 서비스 소개 등 (토스 안내 따르기).

2. **심사**  
   - 토스 측 심사 1~2일, 카드사 심사 최대 14일 등 소요될 수 있음.

3. **라이브 API 키 발급**  
   - 계약·심사 완료 후 **라이브 키** (`live_ck_...`, `live_sk_...`) 발급.

4. **환경 전환**  
   - 테스트 키 → 라이브 키로 교체 (서버 환경변수, 앱 환경변수).  
   - 실제 금액 결제·정산 테스트는 소액으로 검증.

---

## 7단계: 운영 정책 · 법적 고지

1. **이용약관**  
   - 포스페이 조항: 충전금 성격, 환불, 수수료, 유효기간, 약관 링크.

2. **개인정보처리방침**  
   - 결제·정산·PG 제공에 대한 수집·이용·제3자 제공(토스) 명시.

3. **고객 예치금 관리**  
   - 충전금은 매출이 아닌 부채로 관리.  
   - 정산 주기, 출금 한도 등 내부 규정 정리.

4. **과세**  
   - 플랫폼 수수료만 매출로 신고·과세.  
   - 필요 시 세무사와 한 번 더 확인.

---

## 8단계: 체크리스트 (보안 · 법 고려)

- [ ] 시크릿 키는 서버만 사용, 앱/클라이언트에 노출 안 함.
- [ ] 잔액·결제·출금 모두 서버에서만 처리.
- [ ] 결제·충전·출금 로그 전부 저장 (추적 가능).
- [ ] 결제 승인 시 orderId 중복 처리 방지.
- [ ] 이용약관·개인정보처리방침에 포스페이·결제 관련 내용 반영.
- [ ] 테스트 키로 전체 플로우 검증 후, 라이브 키 전환.

---

## 참고 링크

- [토스페이먼츠 개발자센터](https://developers.tosspayments.com/)
- [시작하기 가이드](https://docs.tosspayments.com/guides/v2/get-started)
- [결제 API 레퍼런스](https://docs.tosspayments.com/reference)
- 가맹점 신청·문의: support-pay@toss.im (토스 안내 기준)

---

이 순서대로 진행하면, "토스페이먼츠를 이용한 충전/잔액" 구조를 법·보안을 고려해 단계별로 구축할 수 있습니다.  
실제 구현 시에는 토스 최신 문서와 약관을 반드시 확인하세요.
